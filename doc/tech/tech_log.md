# 技术积累清单

> 记录每个阶段的关键技术选型与实现要点，便于复盘与迁移。

## 2026-01-28
- 基础骨架采用 FastAPI + APScheduler + SQLite，支持本地常驻服务。
- 配置统一使用 `.env` + `QW_` 前缀环境变量，默认参数集中在 `app/core/config.py`。
- 先落地晨报与任务运行记录，确保可运行与可观测的最小闭环。
- 插件接口先定义契约，便于后续按层解耦扩展。
- 增加最小测试用例：SQLite 任务/事件表、晨报格式、健康检查。
- 晨报草稿支持本地存储与 API 编辑/发送，本地 outbox 便于无 webhook 验证。
- 增加 PowerShell 脚本一键发送晨报，便于人工流程。
- 依赖安装在本机需设置 `NO_PROXY='*'` 才可连通 pypi。
- 晨报支持结构化数据文件与 API 管理，优先草稿、缺失时模板自动生成。
- 晨报数据源抽象为连接器，后续可替换外部接口实现。
- A股行情最快路径：使用 AkShare 现货数据生成晨报摘要与榜单。
- watchlist 作为最小输入接口，JSON 文件便于手工维护与后续迁移。
- 增加本地 Web UI，直接查看晨报与手动刷新/发送。
- 刷新接口返回数据统计，UI 展示刷新状态与数量。
- 晨报刷新使用单次快照以降低网络失败概率，并支持 QW_HTTP_PROXY/QW_HTTPS_PROXY。
- 行情连接器支持腾讯行情降级，保证 watchlist 仍可更新。
- AkShare 请求增加指数退避重试，可通过配置提高成功率。
- 新增数据源说明文档：`doc/tech/data_sources.md`。
- 新增盘后复盘提示词草案：`doc/tech/post_close_prompt.md`。
- 盘后提示词扩展了市场概况/约束/风险标记，并给出当前自选股示例输出。
- Web 端新增盘后提示词生成与复制按钮，基于当前晨报结构化数据。
- 刷新流程自动填充自选股价值面与技术面，并支持前端直接添加自选股。
- 盘后提示词强调价值/技术证据链与置信度折扣规则。
- 盘后提示词增加 JSON Schema 输出约束。

## 2026-01-31
- 晨报刷新改为“快照优先 + 研究数据异步”，避免慢数据源阻塞 UI。
- 刷新状态新增来源、耗时、fallback 与研究进度字段，前端可直接展示。
- AkShare/Tencent 增加超时与重试配置，弱网场景更可控。
- 研究数据增加开关与最大标的数限制，降低慢网络影响。
- Web UI 重新排版，增加行情速览与状态提示，错误与超时更友好。
- 盘后提示词加强证据字段与置信度校准，新增 data_quality_score 与 confidence_basis。

## 2026-02-01
- 新增 Eastmoney 直连补全源（分页 + 限速 + 可配置请求头/主机）。
- AkShare 失败时按顺序尝试 Eastmoney 直连，再降级到腾讯行情。
- 增加网络诊断脚本，快速验证代理与 Eastmoney 可达性。
- 新增 Sina 全市场补全源，Eastmoney 不可达时仍可补齐榜单。
- Sina 全市场抓取加入并发与最小行数校验，提升完整性与速度。
- 行情快照支持来源优先级与缓存（可配置 TTL），弱网场景降低超时风险。
- 研究数据修复 AkShare 指标函数缺失，改为 Eastmoney 估值 + 新浪财务分析；技术面补充腾讯历史行情回退。

## 2026-02-04
- 盘后复盘结构化数据与 Markdown 报告落地，支持刷新/发送/查看。
- 报告参数持久化（动量窗口、异常阈值、强弱阈值、盘后时间）。
- watchlist 历史快照缓存，用于动量指标计算与可追溯输出。
- 晨报/盘后共享排名、风险提示与动量指标逻辑。
- UI 增加盘后复盘预览与报告参数配置入口。
